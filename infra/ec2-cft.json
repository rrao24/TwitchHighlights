{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Parameters": {
		"GitUser": {
			"Type": "String",
			"Description": "Enter git username",
			"NoEcho": "true"
		},
		"GitPass": {
			"Type": "String",
			"Description": "Enter git pass",
			"NoEcho": "true"
		},
		"TwitchId": {
			"Type": "String",
			"Description": "Enter twitch client ID",
			"NoEcho": "true"
		},
		"AWSId": {
			"Type": "String",
			"Description": "AWS ID",
			"NoEcho": "true"
		},
		"AWSSecret": {
			"Type": "String",
			"Description": "AWS Secret",
			"NoEcho": "true"
		}
	},
	"Resources": {
		"EC2": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": "ami-0a313d6098716f372",
				"InstanceType": "t2.micro",
				"SecurityGroups": [
					{
						"Ref": "InstanceSecurityGroup"
					}
				],
				"KeyName": "twitch-highlights",
				"UserData": {
					"Fn::Base64": {
						"Fn::Join": [
							"",
							[
								"#!/bin/bash -xe\n",
								"apt-get update -y\n",
								"apt-get install awscli -y\n",
								"apt-get install git -y\n",
								{
									"Fn::Join": [
										"",
										[
											"git clone https://",
											{"Ref": "GitUser"},
											":",
											{"Ref": "GitPass"},
											"@",
											"github.com/rrao24/TwitchHighlights.git\n"
										]
									]
								},
								"apt-get install ffmpeg -y\n",
								"add-apt-repository ppa:stebbins/handbrake-releases\n",
								"apt-get update -y\n",
								"apt-get install handbrake-cli -y\n",
								"export ENVIRONMENT=PROD\n",
								{
									"Fn::Join": [
										"",
										[
											"export CLIENT_ID=",
											{"Ref": "TwitchId"},
											"\n"
										]
									]
								},
								{
									"Fn::Join": [
										"",
										[
											"export AWS_ID=",
											{"Ref": "AWSId"},
											"\n"
										]
									]
								},
								{
									"Fn::Join": [
										"",
										[
											"export AWS_SECRET=",
											{"Ref": "AWSSecret"},
											"\n"
										]
									]
								},
								"apt-get install python3-pip -y\n",
								"cd TwitchHighlights\n",
								"pip3 install -r requirements.txt\n",
								"python3 run.py\n",
								{
									"Fn::Join": [
										"",
										[
											"AWS_ACCESS_KEY_ID=",
											{"Ref": "AWSId"},
											" AWS_SECRET_ACCESS_KEY=",
											{"Ref": "AWSSecret"},
											" aws cloudformation delete-stack --stack-name ",
											{"Ref": "AWS::StackName"},
											" --region us-east-1"
										]
									]
								}
							]
						]
					}
				}
			}
		},
		"InstanceSecurityGroup": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Enable SSH access via port 22",
				"SecurityGroupIngress": {
					"IpProtocol": "tcp",
					"FromPort": "22",
					"ToPort": "22",
					"CidrIp": "0.0.0.0/0"
				}
			}
		}
	}
}        